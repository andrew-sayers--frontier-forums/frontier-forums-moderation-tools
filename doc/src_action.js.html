<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: src/action.js</title>


    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">


    <script>
    var config = {"monospaceLinks":false,"cleverLinks":true,"default":{"outputSourceFiles":true}};
    </script>



</head>
<body>
<div id="wrap" class="clearfix">

<div class="navigation">
    <h3 class="applicationName"><a href="index.html"></a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">

        <li class="item" data-name="AccountHighlighter">
            <span class="title">
                <a href="AccountHighlighter.html">AccountHighlighter</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="AccountHighlighter#highlight"><a href="AccountHighlighter.html#highlight">highlight</a></li>

                <li data-name="AccountHighlighter#highlight_to_element"><a href="AccountHighlighter.html#highlight_to_element">highlight_to_element</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Action">
            <span class="title">
                <a href="Action.html">Action</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Action#blockers"><a href="Action.html#blockers">blockers</a></li>

                <li data-name="Action#fire"><a href="Action.html#fire">fire</a></li>

                <li data-name="Action#fire_with_journal"><a href="Action.html#fire_with_journal">fire_with_journal</a></li>

                <li data-name="Action#long_description"><a href="Action.html#long_description">long_description</a></li>

                <li data-name="Action#then"><a href="Action.html#then">then</a></li>

                <li data-name="Action#title"><a href="Action.html#title">title</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="ActionWidget">
            <span class="title">
                <a href="ActionWidget.html">ActionWidget</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="ActionWidget#action"><a href="ActionWidget.html#action">action</a></li>

                <li data-name="ActionWidget#reset_value"><a href="ActionWidget.html#reset_value">reset_value</a></li>

                <li data-name="ActionWidget#resolve_value"><a href="ActionWidget.html#resolve_value">resolve_value</a></li>

                <li data-name="ActionWidget#set_value"><a href="ActionWidget.html#set_value">set_value</a></li>

                <li data-name="ActionWidget#update_previous_values"><a href="ActionWidget.html#update_previous_values">update_previous_values</a></li>

                <li data-name="ActionWidget#val"><a href="ActionWidget.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="AvailableUsers">
            <span class="title">
                <a href="AvailableUsers.html">AvailableUsers</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="AvailableUsers#active"><a href="AvailableUsers.html#active">active</a></li>

                <li data-name="AvailableUsers#is_ours"><a href="AvailableUsers.html#is_ours">is_ours</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="BulletinBoard">
            <span class="title">
                <a href="BulletinBoard.html">BulletinBoard</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="BulletinBoard#_add_standard_data"><a href="BulletinBoard.html#_add_standard_data">_add_standard_data</a></li>

                <li data-name="BulletinBoard#build_url"><a href="BulletinBoard.html#build_url">build_url</a></li>

                <li data-name="BulletinBoard#config"><a href="BulletinBoard.html#config">config</a></li>

                <li data-name="BulletinBoard#detect_post_error"><a href="BulletinBoard.html#detect_post_error">detect_post_error</a></li>

                <li data-name="BulletinBoard#fix_url"><a href="BulletinBoard.html#fix_url">fix_url</a></li>

                <li data-name="BulletinBoard#get"><a href="BulletinBoard.html#get">get</a></li>

                <li data-name="BulletinBoard#get_pages"><a href="BulletinBoard.html#get_pages">get_pages</a></li>

                <li data-name="BulletinBoard#get_posts"><a href="BulletinBoard.html#get_posts">get_posts</a></li>

                <li data-name="BulletinBoard#parse"><a href="BulletinBoard.html#parse">parse</a></li>

                <li data-name="BulletinBoard#parse_post"><a href="BulletinBoard.html#parse_post">parse_post</a></li>

                <li data-name="BulletinBoard#ping"><a href="BulletinBoard.html#ping">ping</a></li>

                <li data-name="BulletinBoard#post"><a href="BulletinBoard.html#post">post</a></li>

                <li data-name="BulletinBoard#process_posts"><a href="BulletinBoard.html#process_posts">process_posts</a></li>

                <li data-name="BulletinBoard#quotes_process"><a href="BulletinBoard.html#quotes_process">quotes_process</a></li>

                <li data-name="BulletinBoard#stringify"><a href="BulletinBoard.html#stringify">stringify</a></li>

                <li data-name="BulletinBoard#thread_posts"><a href="BulletinBoard.html#thread_posts">thread_posts</a></li>

                <li data-name="BulletinBoard#user_duplicates"><a href="BulletinBoard.html#user_duplicates">user_duplicates</a></li>

                <li data-name="BulletinBoard#when"><a href="BulletinBoard.html#when">when</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Cacheable">
            <span class="title">
                <a href="Cacheable.html">Cacheable</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Cacheable#refresh"><a href="Cacheable.html#refresh">refresh</a></li>

                <li data-name="Cacheable#update_cache"><a href="Cacheable.html#update_cache">update_cache</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Collapse">
            <span class="title">
                <a href="Collapse.html">Collapse</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Collapse#val"><a href="Collapse.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Dashboard">
            <span class="title">
                <a href="Dashboard.html">Dashboard</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Dashboard#refresh"><a href="Dashboard.html#refresh">refresh</a></li>

                <li data-name="Dashboard#update_cache"><a href="Dashboard.html#update_cache">update_cache</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Deadline">
            <span class="title">
                <a href="Deadline.html">Deadline</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Deadline#action"><a href="Deadline.html#action">action</a></li>

                <li data-name="Deadline#reset_value"><a href="Deadline.html#reset_value">reset_value</a></li>

                <li data-name="Deadline#resolve_value"><a href="Deadline.html#resolve_value">resolve_value</a></li>

                <li data-name="Deadline#set_value"><a href="Deadline.html#set_value">set_value</a></li>

                <li data-name="Deadline#update_previous_values"><a href="Deadline.html#update_previous_values">update_previous_values</a></li>

                <li data-name="Deadline#val"><a href="Deadline.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="DuplicateAccountList">
            <span class="title">
                <a href="DuplicateAccountList.html">DuplicateAccountList</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="DuplicateAccountList#_heatmap"><a href="DuplicateAccountList.html#_heatmap">_heatmap</a></li>

                <li data-name="DuplicateAccountList#val"><a href="DuplicateAccountList.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="DuplicateAccountPolicy">
            <span class="title">
                <a href="DuplicateAccountPolicy.html">DuplicateAccountPolicy</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="DuplicateAccountPolicy#_Single">
            <span class="title">
                <a href="DuplicateAccountPolicy__Single.html">DuplicateAccountPolicy#_Single</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="ExtraPost">
            <span class="title">
                <a href="ExtraPost.html">ExtraPost</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="ExtraPost#action"><a href="ExtraPost.html#action">action</a></li>

                <li data-name="ExtraPost#reset_value"><a href="ExtraPost.html#reset_value">reset_value</a></li>

                <li data-name="ExtraPost#resolve_value"><a href="ExtraPost.html#resolve_value">resolve_value</a></li>

                <li data-name="ExtraPost#set_value"><a href="ExtraPost.html#set_value">set_value</a></li>

                <li data-name="ExtraPost#update_previous_values"><a href="ExtraPost.html#update_previous_values">update_previous_values</a></li>

                <li data-name="ExtraPost#val"><a href="ExtraPost.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Help">
            <span class="title">
                <a href="Help.html">Help</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Help#val"><a href="Help.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="InappropriateUsernamePolicy">
            <span class="title">
                <a href="InappropriateUsernamePolicy.html">InappropriateUsernamePolicy</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="IPAddressReport">
            <span class="title">
                <a href="IPAddressReport.html">IPAddressReport</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="IPAddressReport#action"><a href="IPAddressReport.html#action">action</a></li>

                <li data-name="IPAddressReport#bbcode"><a href="IPAddressReport.html#bbcode">bbcode</a></li>

                <li data-name="IPAddressReport#cache_timeout"><a href="IPAddressReport.html#cache_timeout">cache_timeout</a></li>

                <li data-name="IPAddressReport#html"><a href="IPAddressReport.html#html">html</a></li>

                <li data-name="IPAddressReport#users"><a href="IPAddressReport.html#users">users</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="MiscellaneousCache">
            <span class="title">
                <a href="MiscellaneousCache.html">MiscellaneousCache</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="MiscellaneousCache#refresh"><a href="MiscellaneousCache.html#refresh">refresh</a></li>

                <li data-name="MiscellaneousCache#update_cache"><a href="MiscellaneousCache.html#update_cache">update_cache</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="NotificationSelector">
            <span class="title">
                <a href="NotificationSelector.html">NotificationSelector</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="NotificationSelector#action"><a href="NotificationSelector.html#action">action</a></li>

                <li data-name="NotificationSelector#add_known_keys"><a href="NotificationSelector.html#add_known_keys">add_known_keys</a></li>

                <li data-name="NotificationSelector#extra_block"><a href="NotificationSelector.html#extra_block">extra_block</a></li>

                <li data-name="NotificationSelector#mode"><a href="NotificationSelector.html#mode">mode</a></li>

                <li data-name="NotificationSelector#mode_switcher"><a href="NotificationSelector.html#mode_switcher">mode_switcher</a></li>

                <li data-name="NotificationSelector#reset_value"><a href="NotificationSelector.html#reset_value">reset_value</a></li>

                <li data-name="NotificationSelector#resolve_value"><a href="NotificationSelector.html#resolve_value">resolve_value</a></li>

                <li data-name="NotificationSelector#set_value"><a href="NotificationSelector.html#set_value">set_value</a></li>

                <li data-name="NotificationSelector#update_previous_values"><a href="NotificationSelector.html#update_previous_values">update_previous_values</a></li>

                <li data-name="NotificationSelector#val"><a href="NotificationSelector.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Policy">
            <span class="title">
                <a href="Policy.html">Policy</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Policy#_build_keys"><a href="Policy.html#_build_keys">_build_keys</a></li>

                <li data-name="Policy#_build_widget_args"><a href="Policy.html#_build_widget_args">_build_widget_args</a></li>

                <li data-name="Policy#check"><a href="Policy.html#check">check</a></li>

                <li data-name="Policy#close_thread"><a href="Policy.html#close_thread">close_thread</a></li>

                <li data-name="Policy#deadline_action"><a href="Policy.html#deadline_action">deadline_action</a></li>

                <li data-name="Policy#deadline_args"><a href="Policy.html#deadline_args">deadline_args</a></li>

                <li data-name="Policy#duplicate_account_list_args"><a href="Policy.html#duplicate_account_list_args">duplicate_account_list_args</a></li>

                <li data-name="Policy#extra_post_action"><a href="Policy.html#extra_post_action">extra_post_action</a></li>

                <li data-name="Policy#extra_post_args"><a href="Policy.html#extra_post_args">extra_post_args</a></li>

                <li data-name="Policy#get"><a href="Policy.html#get">get</a></li>

                <li data-name="Policy#keys"><a href="Policy.html#keys">keys</a></li>

                <li data-name="Policy#notification_selector_action"><a href="Policy.html#notification_selector_action">notification_selector_action</a></li>

                <li data-name="Policy#notification_selector_args"><a href="Policy.html#notification_selector_args">notification_selector_args</a></li>

                <li data-name="Policy#resolve"><a href="Policy.html#resolve">resolve</a></li>

                <li data-name="Policy#resolve_post"><a href="Policy.html#resolve_post">resolve_post</a></li>

                <li data-name="Policy#severity_slider_args"><a href="Policy.html#severity_slider_args">severity_slider_args</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="RecentList">
            <span class="title">
                <a href="RecentList.html">RecentList</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="RecentList#get"><a href="RecentList.html#get">get</a></li>

                <li data-name="RecentList#push"><a href="RecentList.html#push">push</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Report">
            <span class="title">
                <a href="Report.html">Report</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="SeveritySlider">
            <span class="title">
                <a href="SeveritySlider.html">SeveritySlider</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="SeveritySlider#val"><a href="SeveritySlider.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="SharedStore">
            <span class="title">
                <a href="SharedStore.html">SharedStore</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="SharedStore#change"><a href="SharedStore.html#change">change</a></li>

                <li data-name="SharedStore#interval_transaction"><a href="SharedStore.html#interval_transaction">interval_transaction</a></li>

                <li data-name="SharedStore#transaction"><a href="SharedStore.html#transaction">transaction</a></li>

                <li data-name="SharedStore#val"><a href="SharedStore.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="ThreadManagementPolicy">
            <span class="title">
                <a href="ThreadManagementPolicy.html">ThreadManagementPolicy</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="ThreadManagementPolicy#unmerge_action"><a href="ThreadManagementPolicy.html#unmerge_action">unmerge_action</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="ThreadTitleSelector">
            <span class="title">
                <a href="ThreadTitleSelector.html">ThreadTitleSelector</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="ThreadTitleSelector#check"><a href="ThreadTitleSelector.html#check">check</a></li>

                <li data-name="ThreadTitleSelector#focus"><a href="ThreadTitleSelector.html#focus">focus</a></li>

                <li data-name="ThreadTitleSelector#val"><a href="ThreadTitleSelector.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Variables">
            <span class="title">
                <a href="Variables.html">Variables</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Variables#check"><a href="Variables.html#check">check</a></li>

                <li data-name="Variables#escape"><a href="Variables.html#escape">escape</a></li>

                <li data-name="Variables#get"><a href="Variables.html#get">get</a></li>

                <li data-name="Variables#get_language"><a href="Variables.html#get_language">get_language</a></li>

                <li data-name="Variables#parse"><a href="Variables.html#parse">parse</a></li>

                <li data-name="Variables#refresh"><a href="Variables.html#refresh">refresh</a></li>

                <li data-name="Variables#resolve"><a href="Variables.html#resolve">resolve</a></li>

                <li data-name="Variables#set_namespaces"><a href="Variables.html#set_namespaces">set_namespaces</a></li>

                <li data-name="Variables#update_cache"><a href="Variables.html#update_cache">update_cache</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="VariablesFromFirstPost">
            <span class="title">
                <a href="VariablesFromFirstPost.html">VariablesFromFirstPost</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="VariablesFromFirstPost#check"><a href="VariablesFromFirstPost.html#check">check</a></li>

                <li data-name="VariablesFromFirstPost#escape"><a href="VariablesFromFirstPost.html#escape">escape</a></li>

                <li data-name="VariablesFromFirstPost#get"><a href="VariablesFromFirstPost.html#get">get</a></li>

                <li data-name="VariablesFromFirstPost#get_language"><a href="VariablesFromFirstPost.html#get_language">get_language</a></li>

                <li data-name="VariablesFromFirstPost#parse"><a href="VariablesFromFirstPost.html#parse">parse</a></li>

                <li data-name="VariablesFromFirstPost#refresh"><a href="VariablesFromFirstPost.html#refresh">refresh</a></li>

                <li data-name="VariablesFromFirstPost#resolve"><a href="VariablesFromFirstPost.html#resolve">resolve</a></li>

                <li data-name="VariablesFromFirstPost#set_namespaces"><a href="VariablesFromFirstPost.html#set_namespaces">set_namespaces</a></li>

                <li data-name="VariablesFromFirstPost#update_cache"><a href="VariablesFromFirstPost.html#update_cache">update_cache</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="VariablesFromForum">
            <span class="title">
                <a href="VariablesFromForum.html">VariablesFromForum</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="VariablesFromForum#check"><a href="VariablesFromForum.html#check">check</a></li>

                <li data-name="VariablesFromForum#escape"><a href="VariablesFromForum.html#escape">escape</a></li>

                <li data-name="VariablesFromForum#get"><a href="VariablesFromForum.html#get">get</a></li>

                <li data-name="VariablesFromForum#get_language"><a href="VariablesFromForum.html#get_language">get_language</a></li>

                <li data-name="VariablesFromForum#parse"><a href="VariablesFromForum.html#parse">parse</a></li>

                <li data-name="VariablesFromForum#refresh"><a href="VariablesFromForum.html#refresh">refresh</a></li>

                <li data-name="VariablesFromForum#refresh_thread"><a href="VariablesFromForum.html#refresh_thread">refresh_thread</a></li>

                <li data-name="VariablesFromForum#resolve"><a href="VariablesFromForum.html#resolve">resolve</a></li>

                <li data-name="VariablesFromForum#serialise_thread"><a href="VariablesFromForum.html#serialise_thread">serialise_thread</a></li>

                <li data-name="VariablesFromForum#set_namespaces"><a href="VariablesFromForum.html#set_namespaces">set_namespaces</a></li>

                <li data-name="VariablesFromForum#update_cache"><a href="VariablesFromForum.html#update_cache">update_cache</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="VBulletin">
            <span class="title">
                <a href="VBulletin.html">VBulletin</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="VBulletin.iframe_callbacks"><a href="VBulletin.html#.iframe_callbacks">iframe_callbacks</a></li>

                <li data-name="VBulletin#_add_standard_data"><a href="VBulletin.html#_add_standard_data">_add_standard_data</a></li>

                <li data-name="VBulletin#activity"><a href="VBulletin.html#activity">activity</a></li>

                <li data-name="VBulletin#attachments_delete"><a href="VBulletin.html#attachments_delete">attachments_delete</a></li>

                <li data-name="VBulletin#bbcode_html"><a href="VBulletin.html#bbcode_html">bbcode_html</a></li>

                <li data-name="VBulletin#bbcode_html_newthread"><a href="VBulletin.html#bbcode_html_newthread">bbcode_html_newthread</a></li>

                <li data-name="VBulletin#build_url"><a href="VBulletin.html#build_url">build_url</a></li>

                <li data-name="VBulletin#check_login"><a href="VBulletin.html#check_login">check_login</a></li>

                <li data-name="VBulletin#config"><a href="VBulletin.html#config">config</a></li>

                <li data-name="VBulletin#css_add"><a href="VBulletin.html#css_add">css_add</a></li>

                <li data-name="VBulletin#css_keys"><a href="VBulletin.html#css_keys">css_keys</a></li>

                <li data-name="VBulletin#date_parser"><a href="VBulletin.html#date_parser">date_parser</a></li>

                <li data-name="VBulletin#detect_post_error"><a href="VBulletin.html#detect_post_error">detect_post_error</a></li>

                <li data-name="VBulletin#editor_get"><a href="VBulletin.html#editor_get">editor_get</a></li>

                <li data-name="VBulletin#editor_set"><a href="VBulletin.html#editor_set">editor_set</a></li>

                <li data-name="VBulletin#fix_url"><a href="VBulletin.html#fix_url">fix_url</a></li>

                <li data-name="VBulletin#folder_pms"><a href="VBulletin.html#folder_pms">folder_pms</a></li>

                <li data-name="VBulletin#forum_metadata"><a href="VBulletin.html#forum_metadata">forum_metadata</a></li>

                <li data-name="VBulletin#forum_threads"><a href="VBulletin.html#forum_threads">forum_threads</a></li>

                <li data-name="VBulletin#forums"><a href="VBulletin.html#forums">forums</a></li>

                <li data-name="VBulletin#get"><a href="VBulletin.html#get">get</a></li>

                <li data-name="VBulletin#get_pages"><a href="VBulletin.html#get_pages">get_pages</a></li>

                <li data-name="VBulletin#get_posts"><a href="VBulletin.html#get_posts">get_posts</a></li>

                <li data-name="VBulletin#infraction_give"><a href="VBulletin.html#infraction_give">infraction_give</a></li>

                <li data-name="VBulletin#infraction_give_custom"><a href="VBulletin.html#infraction_give_custom">infraction_give_custom</a></li>

                <li data-name="VBulletin#infraction_ids"><a href="VBulletin.html#infraction_ids">infraction_ids</a></li>

                <li data-name="VBulletin#ip_users"><a href="VBulletin.html#ip_users">ip_users</a></li>

                <li data-name="VBulletin#login"><a href="VBulletin.html#login">login</a></li>

                <li data-name="VBulletin#login_auto"><a href="VBulletin.html#login_auto">login_auto</a></li>

                <li data-name="VBulletin#moderation_page"><a href="VBulletin.html#moderation_page">moderation_page</a></li>

                <li data-name="VBulletin#on_posts_modified"><a href="VBulletin.html#on_posts_modified">on_posts_modified</a></li>

                <li data-name="VBulletin#parse"><a href="VBulletin.html#parse">parse</a></li>

                <li data-name="VBulletin#parse_post"><a href="VBulletin.html#parse_post">parse_post</a></li>

                <li data-name="VBulletin#ping"><a href="VBulletin.html#ping">ping</a></li>

                <li data-name="VBulletin#pm_send"><a href="VBulletin.html#pm_send">pm_send</a></li>

                <li data-name="VBulletin#post"><a href="VBulletin.html#post">post</a></li>

                <li data-name="VBulletin#post_create"><a href="VBulletin.html#post_create">post_create</a></li>

                <li data-name="VBulletin#post_delete"><a href="VBulletin.html#post_delete">post_delete</a></li>

                <li data-name="VBulletin#post_edit"><a href="VBulletin.html#post_edit">post_edit</a></li>

                <li data-name="VBulletin#post_info"><a href="VBulletin.html#post_info">post_info</a></li>

                <li data-name="VBulletin#post_report"><a href="VBulletin.html#post_report">post_report</a></li>

                <li data-name="VBulletin#post_summary"><a href="VBulletin.html#post_summary">post_summary</a></li>

                <li data-name="VBulletin#posts_moderated"><a href="VBulletin.html#posts_moderated">posts_moderated</a></li>

                <li data-name="VBulletin#posts_move"><a href="VBulletin.html#posts_move">posts_move</a></li>

                <li data-name="VBulletin#process_posts"><a href="VBulletin.html#process_posts">process_posts</a></li>

                <li data-name="VBulletin#quotes_process"><a href="VBulletin.html#quotes_process">quotes_process</a></li>

                <li data-name="VBulletin#redirect_modcp_ipsearch"><a href="VBulletin.html#redirect_modcp_ipsearch">redirect_modcp_ipsearch</a></li>

                <li data-name="VBulletin#server_stats"><a href="VBulletin.html#server_stats">server_stats</a></li>

                <li data-name="VBulletin#spammer_delete"><a href="VBulletin.html#spammer_delete">spammer_delete</a></li>

                <li data-name="VBulletin#stringify"><a href="VBulletin.html#stringify">stringify</a></li>

                <li data-name="VBulletin#thread_bump"><a href="VBulletin.html#thread_bump">thread_bump</a></li>

                <li data-name="VBulletin#thread_create"><a href="VBulletin.html#thread_create">thread_create</a></li>

                <li data-name="VBulletin#thread_debump"><a href="VBulletin.html#thread_debump">thread_debump</a></li>

                <li data-name="VBulletin#thread_delete"><a href="VBulletin.html#thread_delete">thread_delete</a></li>

                <li data-name="VBulletin#thread_edit"><a href="VBulletin.html#thread_edit">thread_edit</a></li>

                <li data-name="VBulletin#thread_merge"><a href="VBulletin.html#thread_merge">thread_merge</a></li>

                <li data-name="VBulletin#thread_metadata"><a href="VBulletin.html#thread_metadata">thread_metadata</a></li>

                <li data-name="VBulletin#thread_move"><a href="VBulletin.html#thread_move">thread_move</a></li>

                <li data-name="VBulletin#thread_openclose"><a href="VBulletin.html#thread_openclose">thread_openclose</a></li>

                <li data-name="VBulletin#thread_posts"><a href="VBulletin.html#thread_posts">thread_posts</a></li>

                <li data-name="VBulletin#thread_reply"><a href="VBulletin.html#thread_reply">thread_reply</a></li>

                <li data-name="VBulletin#thread_title"><a href="VBulletin.html#thread_title">thread_title</a></li>

                <li data-name="VBulletin#thread_whoposted"><a href="VBulletin.html#thread_whoposted">thread_whoposted</a></li>

                <li data-name="VBulletin#threads_complete"><a href="VBulletin.html#threads_complete">threads_complete</a></li>

                <li data-name="VBulletin#threads_recent"><a href="VBulletin.html#threads_recent">threads_recent</a></li>

                <li data-name="VBulletin#url_decode"><a href="VBulletin.html#url_decode">url_decode</a></li>

                <li data-name="VBulletin#user_ban"><a href="VBulletin.html#user_ban">user_ban</a></li>

                <li data-name="VBulletin#user_current"><a href="VBulletin.html#user_current">user_current</a></li>

                <li data-name="VBulletin#user_duplicates"><a href="VBulletin.html#user_duplicates">user_duplicates</a></li>

                <li data-name="VBulletin#user_info"><a href="VBulletin.html#user_info">user_info</a></li>

                <li data-name="VBulletin#user_ips"><a href="VBulletin.html#user_ips">user_ips</a></li>

                <li data-name="VBulletin#user_moderation_info"><a href="VBulletin.html#user_moderation_info">user_moderation_info</a></li>

                <li data-name="VBulletin#user_notes"><a href="VBulletin.html#user_notes">user_notes</a></li>

                <li data-name="VBulletin#user_overlapping"><a href="VBulletin.html#user_overlapping">user_overlapping</a></li>

                <li data-name="VBulletin#user_posts"><a href="VBulletin.html#user_posts">user_posts</a></li>

                <li data-name="VBulletin#user_signature_get"><a href="VBulletin.html#user_signature_get">user_signature_get</a></li>

                <li data-name="VBulletin#user_signature_set"><a href="VBulletin.html#user_signature_set">user_signature_set</a></li>

                <li data-name="VBulletin#usernote_add"><a href="VBulletin.html#usernote_add">usernote_add</a></li>

                <li data-name="VBulletin#usernote_edit"><a href="VBulletin.html#usernote_edit">usernote_edit</a></li>

                <li data-name="VBulletin#usernote_info"><a href="VBulletin.html#usernote_info">usernote_info</a></li>

                <li data-name="VBulletin#users_complete"><a href="VBulletin.html#users_complete">users_complete</a></li>

                <li data-name="VBulletin#users_list_new"><a href="VBulletin.html#users_list_new">users_list_new</a></li>

                <li data-name="VBulletin#when"><a href="VBulletin.html#when">when</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="VbulletinPopupMenu">
            <span class="title">
                <a href="VbulletinPopupMenu.html">VbulletinPopupMenu</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="VbulletinPopupMenu#val"><a href="VbulletinPopupMenu.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Violations">
            <span class="title">
                <a href="Violations.html">Violations</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Violations#refresh"><a href="Violations.html#refresh">refresh</a></li>

                <li data-name="Violations#update_cache"><a href="Violations.html#update_cache">update_cache</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Widget">
            <span class="title">
                <a href="Widget.html">Widget</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Widget#val"><a href="Widget.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="src_action.js.html">Source: src/action.js</h1>




    <section>
        <article>
            <pre class="prettyprint source "><code>/**
 * @file Manage a directed acyclic graph of moderation actions
 * @author Andrew Sayers
 * @description Manage actions that could be taken while e.g. resolving a report
 * Most actions are represented by a tree of Promise objects - the root set of promises fires first, followed by branch promises, towards leaf promises.
 * We occasionally need branches to join up again, so in the general case it's not a tree but a directed acyclic graph.
 *
 * See action-explanation.js for an overview of how to use Actions
 */

/**
 * @summary Manage a node and associated subset of the action graph
 * @param {...(Action|Array|Object)} var_args (arrays of) promises to fire
 * @constructor
 *
 * @example
 * var my_action = new Action(
 *     'Action title', // used to make debugging data more readable
 *     // pass a list of promises that will be executed
 *     {
 *         fire: function() { // called by action.fire()
 *             return $.post(...);
 *         },
 *         description: function() { // optional: return debugging information
 *             return [
 *                 { type: "PM", target: {username: 'Joe Bloggs', user_id: 12345  } },
 *             ];
 *         },
 *         blockers: function() {
 *             return [ 'Message describing how to resolve the thing blocking the action' ];
 *         },
 *     },
 *     // further promises will be executed in parallel:
 *     new Action(...),
 *     [ { ... }, new Action(...) ], // arrays are expanded automatically
 *     // ...
 * );
 */
function Action(title) {

    var promises  = this._promises  = [];
    var contained = this._contained = [];
    this._children  = [];
    this._level     = null;
    this._title     = title;

    function add(action) {
        if ( typeof(action) == 'undefined' ) {
            // ignore e.g. undefined values returned from a 'map' function
        } else if ( action instanceof Action ) {
            contained.push(action);
        } else if ( action !== null ) {
            promises .push(action);
        }
    }

    for ( var n=1; n!=arguments.length; ++n ) {
        if ( $.isArray(arguments[n]) )
            arguments[n].forEach(add);
        else
            add(arguments[n]);
    }

}

Action.prototype = Object.create(Object, {
    _promises  : { writable: true , configurable: false },
    _contained : { writable: true , configurable: false },
    _children  : { writable: true , configurable: false },
    _level     : { writable: true , configurable: false },
    _fire_count: { writable: true , configurable: false },
    _title     : { writable: true , configurable: false },
    _debug     : { writable: true , configurable: false, value: false } // check for programming errors in actions
});
Action.prototype.constructor = Action;

/**
 * @summary add another action that will fire after this completes
 * @param {...Action} actions actions to add
 * @return {Action} the current action
 * @description
 * This mimics jQuery's "then" API, but we currently modify the existing action instead of returning a new one.
 * This was an implementation shortcut and might be fixed if we find a use for the full behaviour
 */
Action.prototype.then = function() {

    var children = this._children;

    function add(action) {
        if ( typeof(action) == 'undefined' ) {
            // ignore e.g. undefined values returned from a 'map' function
        } else if ( action !== null ) {
            children.push(action);
        }
    }

    for ( var n=0; n!=arguments.length; ++n ) {
        if ( $.isArray(arguments[n]) )
            arguments[n].forEach(add);
        else
            add(arguments[n]);
    }

    return this;

}

/**
 * @summary fire the graph of actions starting with this one
 * @param {BulletinBoard} bb   BulletinBoard
 * @param {Object}        keys keys to pass to all actions
 * @return {jQuery.Promise} promise representing the full graph of actions
 *
 * @description the promise will be resolved when the final action is resolved,
 * or rejected shortly after the first action fails (ongoing requests will be allowed to finish).
 * progress() will be called regularly with a fraction representing the completeness of the complete set of actions.
 */
Action.prototype.fire = function(bb, keys) {

    /*
     * STEP ONE: calculate "progress levels"
     *
     * We calculate progress using the polite fiction that all actions at each level in the graph are fired at the same time.
     * Actions actually fire as soon as they're ready, but the progress bar looks prettier if we think of it that way
     *
     * 1. Actions are assigned "levels" based on their depth in the action graph
     * 2. The total number of promises at each level is calculated
     * 3. Each time an action's promise completes, progress increases by 100 / (number of promises at this level * total number of levels)
     *
     */

    var blockers = this.blockers();
    if ( blockers.length ) {
        alert( ['Blocked - please resolve the following issues:\n'].concat(blockers).join( "\n* " ) );
        return $.Deferred().reject().promise();
    }

    var promises_per_level = [ 0 ];

    function set_level(action, level) {

        action._fire_count = 0;

        if ( action._level != null ) throw "Please fix your action graph so this Action only appears at one point: " + JSON.stringify(action);
        action._level = level;

        if ( promises_per_level.length &lt;= level ) promises_per_level[level] = 0;
        promises_per_level[level] += action._promises.length;

        // set level for contained actions, and calculate level at which child actions will fire
        var child_level = level;
        if ( action._promises.length ) ++child_level;
        action._contained.forEach(function(action) {
            var action_level = set_level( action, level );
            if ( child_level &lt; action_level ) child_level = action_level;
        });

        var deepest_leaf_level = child_level; // level of the deepest leaf node fired by the action subgraph rooted at this node
        action._children.forEach(function(action) {
            var action_level = set_level(action, child_level);
            if ( deepest_leaf_level &lt; action_level ) deepest_leaf_level = action_level;
        });

        return deepest_leaf_level;

    }
    set_level( this, 0 );

    function get_title(promise) {
        if ( !promise.hasOwnProperty('description') ) return;
        var descriptions = promise.description();
        if ( !descriptions ) return;
        descriptions = descriptions.map(function(desc) {
            switch ( desc.type ) {

            case 'PM'        : return      'PM [URL="' + location.origin + bb.url_for.user_show({ user_id: desc.target.user_id }) + '"]' + desc.target.username + '[/URL]';
            case 'warning'   : return    'warn [URL="' + location.origin + bb.url_for.user_show({ user_id: desc.target.user_id }) + '"]' + desc.target.username + '[/URL]';
            case 'infraction': return 'infract [URL="' + location.origin + bb.url_for.user_show({ user_id: desc.target.user_id }) + '"]' + desc.target.username + '[/URL]';

            case 'usernote'  : return 'update [URL="' + location.origin + bb.url_for.user_notes({ user_id: desc.target.user_id }) + '"]user notes for ' + desc.target.username + '[/URL]';

            case 'close'     : return 'close [thread=' + desc.target.thread_id + ']' + desc.target.thread_desc + '[/thread]';
            case 'post'      : return 'reply to ' + (
                desc.target.post_id
                ?   '[post=' + desc.target.  post_id + ']' + desc.target.thread_desc + '[/post]'
                : '[thread=' + desc.target.thread_id + ']' + desc.target.thread_desc + '[/thread]'
            );

            case 'create thread': return (
                desc.target.thread_id
                ? 'Create [thread=' + desc.target.thread_id + ']' + desc.target.title + '[/thread]'
                : 'Create '                                       + desc.target.title
            );

            case 'move posts':
                var posts = desc.target.posts.map(function(post) { return '[post=' + post + ']post #' + post + '[/post]' });
                switch ( posts.length ) {
                case 0 : posts = '(an empty list of posts)'; break;
                case 1 : posts = posts[0]; break;
                default: posts = posts.join(', ').replace( /(.*),/, '$1 and' ); break;
                };
                return 'Move ' + posts + ' to [thread=' + desc.target.thread.thread_id + ']' + ( desc.target.thread.title + '[/thread]' );

            case 'change thread forum' : return 'change forum for [thread='  + desc.target.thread_id + ']' + desc.target.thread_desc + '[/thread]';
            case 'change thread title' : return 'change title for [thread='  + desc.target.thread_id + ']' + desc.target.thread_desc + '[/thread]';
            case 'change thread status': return 'change status for [thread=' + desc.target.thread_id + ']' + desc.target.thread_desc + '[/thread]';
            case 'change thread prefix': return 'change prefix for [thread=' + desc.target.thread_id + ']' + desc.target.thread_desc + '[/thread]';
            case 'change thread icon'  : return 'change icon for [thread='   + desc.target.thread_id + ']' + desc.target.thread_desc + '[/thread]';

            case 'user IPs'  : return 'Download [URL="' + location.origin + bb.url_for.moderation_ipsearch($.extend( {depth:2}, desc.target )) + '"]IP address report for ' + desc.target.username + '[/URL]';
            case 'IP users'  : return 'Download user reports for ' + desc.target.length + ' IP address(es)';

            default          : return desc.type;

            }
        });
        switch ( descriptions.length ) {
        case 0: return;
        case 1: return descriptions[0];
        default:
            var last = descriptions.pop();
            return descriptions.join(', ') + ' and ' + last;
        }
    }

    /*
     * STEP TWO: fire actions in turn
     */

    var graph_dfd = $.Deferred();

    var progress = 0;

    var completed_promises = [];
    var failure_count = 0;

    function fire_action( action, keys, done_cb ) {

        if ( action._fire_count++ ) {
            throw "Giving up: cycle detected in action graph";
        }

        if ( failure_count ) return done_cb({ keys: keys }); // on failure, exit at the earliest convenience

        keys = $.extend( {}, keys ); // clone keys

        var start_time = new Date();
        var in_progress = 1; // in case of actions that return instantly, (see the last line in this function)

        // called when a child action completes:
        function child_completed(ret) {
            $.extend( keys, ret.keys );
            if ( !--in_progress ) done_cb({ keys: keys });
        }

        // called when all contained promises/actions have completed:
        function node_completed() {
            if ( action._children.length ) {
                in_progress = action._children.length;
                action._children.forEach(function(action) { fire_action( action, keys, child_completed ) });
            } else {
                done_cb({ keys: keys });
            }
        }

        // called when a contained promise or action completes:
        function contained_completed(ret, promise, result, error) {

            if ( ret &amp;&amp; ret.hasOwnProperty('keys') ) $.extend( keys, ret.keys );

            if ( promise ) {
                promise.result     = result;
                promise.start_time = start_time;
                promise.end_time   = new Date();
                promise.error      = ( typeof(error) == 'string' ) ? error : '';
                promise.title      = get_title(promise);
                if ( !promise.title ) delete promise.title;
                completed_promises.push(promise);

                progress += 100 / promises_per_level[action._level];
                graph_dfd.notify( Math.floor( progress / promises_per_level.length ) );
            }

            if ( !--in_progress ) node_completed();

        }

        action._promises.forEach(function(promise) {
            if ( promise ) {
                if ( Action.prototype._debug ) {
                    try {
                        promise.promise = promise.fire($.extend( {}, keys ) );
                    } catch (error) {
                        console.log( action._title + ': ' + error, promise );
                        alert      ( action._title + ': ' + error );
                        throw error;
                    };
                } else {
                    promise.promise = promise.fire($.extend( {}, keys ) );
                }

                if ( promise.promise) {
                    ++in_progress;
                    if ( promise.promise.then ) { // looks like a promise
                        promise.promise = promise.promise.then(
                            function(ret) {                  contained_completed(ret , promise, 'success', null) },
                            function(err) { ++failure_count; contained_completed(null, promise, 'fail'   , err ) }
                        );
                    } else if ( promise.promise.keys ) { // looks like keys
                        contained_completed( promise.promise, null, 'success', null);
                    }
                }
            }
        });

        in_progress += action._contained.length;
        action._contained.forEach(function(action) { fire_action( action, keys, contained_completed ) });

        if ( !--in_progress ) node_completed(); // subtract the initial 'in progress' action

    }

    fire_action( this, keys, function(keys) {
        if ( failure_count )
            graph_dfd.reject ( completed_promises, keys.keys );
        else
            graph_dfd.resolve( completed_promises, keys.keys );
    });

    return graph_dfd.promise();

}

/**
 * @summary call fire(), with values logged to a journal post
 * @param {BulletinBoard}         bb        BulletinBoard
 * @param {Object}                keys      keys to pass to all actions
 * @param {Variables}             v         object to retrieve variables from
 * @param {Number}                thread_id thread to post the journal in
 * @param {string}                namespace namespace to retrieve journal variables from
 * @param {name}                  name      unique name of this action
 * @param {Array.&lt;BulletinBoard>} extra_bbs other BulletinBoards to check before firing
 * @return {jQuery.Promise} promise representing the full graph of actions
 *
 * @description To improve the audit trail for large actions, you might want to
 * record the action you're about to perform, perform the action, then record
 * the outcome.
 *
 * This function posts a reply to a thread, calls .fire(), then edits the
 * post when .fire() completes.  Posts will be constructed using variables
 * named [ name + ( ' title' or ' body' ), 'before' or 'after' ], e.g.
 * [ name+' title', 'before' ] will be used to get the title for the "before" post.
 */
Action.prototype.fire_with_journal = function(bb, keys, v, thread_id, namespace, name, extra_bbs) {

    var action = this;

    var sort_order = {
        title    : 0,
        promises : 1,
        contained: 2,
        children : 3
    }

    keys['debug info'] = v.escape(
        bb.stringify(
            namespace + ': ' + name,
            this.long_description(),
            function(a,b) { return sort_order[a.key] &lt; sort_order[b.key] ? -1 : 1 }
        )
    );

    function finalise(completed_promises, journal_post_id, keys, result) {

        var start_time = completed_promises[0].start_time;

        keys['action result data'] =
            'Action started at: ' + start_time + "\n" +
            '[table]'
        ;

        completed_promises = completed_promises.filter(function(promise) { return promise.hasOwnProperty('title') });

        var has_errors = completed_promises.reduce(function(prev,promise) { return prev + promise.error }, '' ) != '';
        keys['action result data'] += (
            has_errors
            ? '[tr][th]Result[/th][th]Time[/th][th]Duration[/th][th]title[/th][th]error[/th][/tr]'
            : '[tr][th]Result[/th][th]Time[/th][th]Duration[/th][th]title[/th][/tr]'
        );

        var escape_div = $('&lt;div>&lt;/div>');

        keys['action result data'] += completed_promises.map(function(promise) {
            return '[tr]' +
                ( ( promise.result == 'success' ) ? '[td]:) success' : '[td]:o failure' ) + '[/td]' +
                '[td]' + ( ( promise.start_time.getTime() - start_time.getTime() ) / 1000 ) + 's[/td]' +
                '[td]' + ( ( promise.end_time.getTime() - promise.start_time.getTime() ) / 1000 ) + 's[/td]' +
                '[td]' + promise.title + '[/td]' +
                ( has_errors
                  ? '[td][noparse]' + escape_div.text( promise.error ).html() + '[/noparse][/td]'
                  : ''
                ) +
                '[/tr]';
        }).join('');

        var end_time = completed_promises.reduce(function(prev, p) { return prev.getTime() > p.end_time ? prev : p.end_time }, start_time );
        keys['action result data'] +=
            '[/table]\n' +
            'Action completed at: ' + end_time + ' (total duration: ' + ( ( end_time.getTime() - start_time.getTime() ) / 1000 ) + 's)'
        ;

        return bb.post_edit({
            post_id: journal_post_id,
            title : v.resolve(namespace, [ name + ' title', 'after' ], keys),
            bbcode: v.resolve(namespace, [ name + ' body' , 'after' ], keys),
            reason: 'action ' + result
        });

    }

    var blockers = this.blockers();
    if ( blockers.length ) {
        alert( ['Blocked - please resolve the following issues:\n'].concat(blockers).join( "\n* " ) );
        return $.Deferred().reject().promise();
    }

    var promises = [
        bb.ping().then(function(data) {
            if ( data.result == 'success' ) {
                if ( ( data.duration &lt; 1000 ) ||
                     (typeof(prompt(
                         'This might make things worse!\n' +
                         "Recommended: click 'cancel' to stop the action, then try again in a few hours\n" +
                         "Alternative: read the link below then click 'OK' to continue anyway\n",
                         location.origin + bb.url_for.thread_show({ thread_id: v.resolve( 'frequently used posts/threads', 'Slow Server explanation thread' ) })
                     )) == 'string')
                   )
                    return; // successful return
            } else {
                alert(
                    'The server could not be contacted.\n' +
                    "Please make sure you and the server are online, then try again."
                );
            }
            return $.Deferred().reject().promise(); // only reached if we don't get the successful return above
        }),
        bb.check_login().fail(function(message) {
            alert(message + "\nPlease resolve this problem, then try again.");
        })
    ];
    if ( extra_bbs ) extra_bbs.forEach(function(extra_bb) {
        promises.push(extra_bb.check_login().fail(function(message) {
            alert(message + "\nPlease resolve this problem, then try again.");
        }));
    });

    return $.when.apply( $, promises ).then(function() {
        return bb.thread_reply({
            thread_id: thread_id,
            title    : v.resolve(namespace, [ name + ' title', 'before' ], keys),
            bbcode   : v.resolve(namespace, [ name + ' body' , 'before' ], keys)
        }).then(function(journal_post_id) {

            keys['journal thread id'] = thread_id;
            keys['journal post id' ] = journal_post_id;

            return action.fire(bb, keys).then(
                function(completed_promises, keys) { return finalise( completed_promises, journal_post_id, keys, 'succeeded' ) },
                function(completed_promises, keys) { return finalise( completed_promises, journal_post_id, keys, 'failed'    ) }
            );

        });
    });

}


/**
 * @summary Long description of actions that will be performed (suitable for debugging use)
 * @return {string} long description
 */
Action.prototype.long_description = function() {

    // Get all the descriptions in the subgraph rooted at this node:
    var root_description = [], all_descriptions = [];
    var actions = [ [ root_description, this ] ];
    while ( actions.length ) {
        var action = actions.shift();
        var parent_description = action[0];
        action = action[1];
        var description = {
            title   : action._title,
            promises: action._promises.map(function(promise) {
                if ( promise.hasOwnProperty('description') ) return promise.description();
            }),
            contained: [],
            children: []
        };
        action._contained.forEach(function(action) { actions.push([ description.contained, action ]) });
        action._children .forEach(function(action) { actions.push([ description.children , action ]) });
        parent_description.push(description);
        all_descriptions.push(description);
    }

    // have to do this once .contained is fully populated:
    all_descriptions.forEach(function(description) {
        if ( !description.promises .reduce(function(prev, item) { return prev || item }, false ) ) delete description.promises;
        if ( !description.children .reduce(function(prev, item) { return prev || item }, false ) ) delete description.children;
        if ( !description.contained.reduce(function(prev, item) { return prev || item }, false ) ) delete description.contained;
    });

    root_description[0].description_build_time = new Date().getTime();

    return root_description[0];

}

/**
 * @summary describe the graph of actions starting with this one
 * @return {Array.&lt;string>} short descriptions
 */
Action.prototype.title = function() {

    var descriptions = [];
    // Get all the descriptions in the subgraph rooted at this node:
    function get_descriptions(action) {
        action._promises.forEach(function(promise) {
            if ( !promise.hasOwnProperty('description') ) return;
            var desc = promise.description();
            if ( desc ) descriptions = descriptions.concat( desc );
        });
        action._contained.forEach(get_descriptions);
        action._children .forEach(get_descriptions);
    }
    get_descriptions(this);

    // Convert the list of actions to a user-friendly string:

    // STEP ONE: group together actions on a common target:
    var descriptions_by_target = { user: [], thread: [], 'change thread': [], 'create thread': [], posts: [] }, target_types = {

        'PM'        : 'user',
        'warning'   : 'user',
        'infraction': 'user',
        'usernote'  : 'user',
        'user IPs'  : 'user',

        'post' : 'thread',
        'close': 'thread',

        'create': 'create thread',
        'posts': 'posts',

        'change thread forum' : 'change thread',
        'change thread title' : 'change thread',
        'change thread status': 'change thread',
        'change thread prefix': 'change thread',
        'change thread icon'  : 'change thread'

    };
    descriptions.forEach(function(description, index) {

        if ( !target_types.hasOwnProperty(description.type) ) return;

        var target_type = target_types[description.type];
        var target = target_type == 'user' ? description.target.user_id : description.target.thread_id;
        if ( descriptions_by_target[target_type].hasOwnProperty(target) )
            descriptions_by_target[target_type][target].push( description );
        else
            descriptions_by_target[target_type][target] = [ description ];
    });
    Object.keys(descriptions_by_target).forEach(function(target) {
        descriptions_by_target[target].forEach(function(desc_list) {
            if ( desc_list.length == 1 ) return;
            desc_list[desc_list.length-1].type = desc_list.map(function(desc) {
                desc.ignore = true;
                switch ( desc.type ) {
                case 'PM'        : return 'PM';
                case 'warning'   : return 'warn';
                case 'infraction': return 'infract';
                case 'usernote'  : return 'add a note for';
                case 'user IPs'  : return 'build IP address report for';
                case 'post'      : return 'reply to';
                case 'close'     : return 'close';
                case 'create thread': return 'create';
                case 'move posts': return 'move';
                case 'change thread forum' : return 'forum';
                case 'change thread title' : return 'title';
                case 'change thread status': return 'status';
                case 'change thread prefix': return 'prefix';
                case 'change thread icon'  : return 'icon';
                default: throw 'impossible: ' + desc.type;
                }
            }).join(', ').replace( /, ([^,]*)$/, " and $1 " ).replace( / for,/, ',' );
            desc_list[desc_list.length-1].multiple_target = target;
        });
    });
    descriptions = descriptions.filter(function(desc) { return desc.multiple_target || !desc.ignore });

    // STEP TWO: GROUP ACTIONS BY TYPE
    var descriptions_by_type = {}, descriptions_list = [];

    descriptions.forEach(function(description, index) {
        if ( descriptions_by_type.hasOwnProperty(description.type) ) {
            descriptions_by_type[ description.type ].highest_index = index;
            descriptions_by_type[ description.type ].targets.push( description.target );
        } else {
            descriptions_list.push(
                descriptions_by_type[ description.type ] = { type: description.type, multiple_target: description.multiple_target, targets: [ description.target ], highest_index: index }
            );
        }
    });

    // STEP THREE: BUILD THE LIST
    return descriptions_list.sort(function(a,b) { return b.highest_index &lt; a.highest_index }).map(function(desc_type) {
        var targets = desc_type.targets;
        switch ( desc_type.multiple_target ) {
        case 'user'  : return ( targets.length == 1 ) ? desc_type.type + targets[0].username : desc_type.type + targets.length + ' users';
        case 'thread': return ( targets.length == 1 ) ? desc_type.type + targets[0].thread_desc : desc_type.type + targets.length + ' threads';
        case 'change thread': return ( targets.length == 1 ) ? 'change ' + desc_type.type + 'for ' + targets[0].thread_desc : 'change ' + desc_type.type + 'for ' + targets.length + ' threads';
        case undefined:
            switch ( desc_type.type ) {

            case 'PM'        : return ( targets.length == 1 ) ? 'PM '      +          targets[0].username    : 'send '    + targets.length + ' PMs';
            case 'warning'   : return ( targets.length == 1 ) ? 'warn '    +          targets[0].username    : 'warn '    + targets.length + ' accounts';
            case 'infraction': return ( targets.length == 1 ) ? 'infract ' +          targets[0].username    : 'infract ' + targets.length + ' accounts';
            case 'usernote'  : return ( targets.length == 1 ) ? 'update notes for ' + targets[0].username    : 'update '  + targets.length + ' user notes';

            case 'post'      : return ( targets.length == 1 ) ? 'reply to ' +         targets[0].thread_desc : 'post '    + targets.length + ' replies';
            case 'close'     : return ( targets.length == 1 ) ? 'close '    +         targets[0].thread_desc : 'close '   + targets.length + ' threads';

            case 'create thread': return ( targets.length == 1 ) ? 'create a new thread' : 'create '   + targets.length + ' threads';
            case 'move posts'   :
                var post_count = targets.reduce( function(prev, t) { return prev + t.posts.length }, 0 );
                return ( post_count == 1 ) ? 'move one post'       : 'move '     + post_count + ' posts';

            case 'change thread forum' :
            case 'change thread title' :
            case 'change thread status':
            case 'change thread prefix':
            case 'change thread icon'  :
                var prefix = 'change ' + desc_type.type.substr(14) + ' for ';
                return ( targets.length == 1 ) ? prefix + targets[0].thread_desc : prefix + targets.length + ' threads';

            case 'user IPs'  :
                if ( targets.length == 1 )
                    return 'Build IP address report for ' + targets[0].username;
                else
                    return 'Build IP address report(s) for ' + targets.length + ' users';
            default:
                if ( targets.length == 1 )
                    return desc_type.type
                else
                    return desc_type.type + ' x ' + desc_type.targets.length;
            }
        }
    });

}

/**
 * @summary list of things blocking the action from firing
 * @return {Array.&lt;string>} list of blockers
 */
Action.prototype.blockers = function() {

    var blockers = [];
    // Get all the blockers in the subgraph rooted at this node:
    function get_blockers(action) {
        action._promises.forEach(function(promise) {
            if ( !promise.hasOwnProperty('blockers') ) return;
            var blocker = promise.blockers();
            if ( blocker ) blockers = blockers.concat( blocker );
        });
        action._contained.forEach(get_blockers);
        action._children .forEach(get_blockers);
    }
    get_blockers(this);

    return blockers;

}
</code></pre>
        </article>
    </section>








        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta1</a> on 27 July 2015
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
