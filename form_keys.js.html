<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: form_keys.js</title>


    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">


    <script>
    var config = {"monospaceLinks":false,"cleverLinks":true,"default":{"outputSourceFiles":true}};
    </script>



</head>
<body>
<div id="wrap" class="clearfix">

<div class="navigation">
    <h3 class="applicationName"><a href="index.html"></a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">

        <li class="item" data-name="BulletinBoard">
            <span class="title">
                <a href="BulletinBoard.html">BulletinBoard</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="BulletinBoard#_add_standard_data"><a href="BulletinBoard.html#_add_standard_data">_add_standard_data</a></li>

                <li data-name="BulletinBoard#build_url"><a href="BulletinBoard.html#build_url">build_url</a></li>

                <li data-name="BulletinBoard#detect_post_error"><a href="BulletinBoard.html#detect_post_error">detect_post_error</a></li>

                <li data-name="BulletinBoard#get"><a href="BulletinBoard.html#get">get</a></li>

                <li data-name="BulletinBoard#get_pages"><a href="BulletinBoard.html#get_pages">get_pages</a></li>

                <li data-name="BulletinBoard#get_posts"><a href="BulletinBoard.html#get_posts">get_posts</a></li>

                <li data-name="BulletinBoard#post"><a href="BulletinBoard.html#post">post</a></li>

                <li data-name="BulletinBoard#process_posts"><a href="BulletinBoard.html#process_posts">process_posts</a></li>

                <li data-name="BulletinBoard#quotes_process"><a href="BulletinBoard.html#quotes_process">quotes_process</a></li>

                <li data-name="BulletinBoard#thread_posts"><a href="BulletinBoard.html#thread_posts">thread_posts</a></li>

                <li data-name="BulletinBoard#when"><a href="BulletinBoard.html#when">when</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Cacheable">
            <span class="title">
                <a href="Cacheable.html">Cacheable</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Cacheable#refresh"><a href="Cacheable.html#refresh">refresh</a></li>

                <li data-name="Cacheable#update_cache"><a href="Cacheable.html#update_cache">update_cache</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Dashboard">
            <span class="title">
                <a href="Dashboard.html">Dashboard</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Report">
            <span class="title">
                <a href="Report.html">Report</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="SeveritySlider">
            <span class="title">
                <a href="SeveritySlider.html">SeveritySlider</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="SeveritySlider#val"><a href="SeveritySlider.html#val">val</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Variables">
            <span class="title">
                <a href="Variables.html">Variables</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Variables#check"><a href="Variables.html#check">check</a></li>

                <li data-name="Variables#get"><a href="Variables.html#get">get</a></li>

                <li data-name="Variables#parse"><a href="Variables.html#parse">parse</a></li>

                <li data-name="Variables#resolve"><a href="Variables.html#resolve">resolve</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="VBulletin">
            <span class="title">
                <a href="VBulletin.html">VBulletin</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="VBulletin#_add_standard_data"><a href="VBulletin.html#_add_standard_data">_add_standard_data</a></li>

                <li data-name="VBulletin#attachments_delete"><a href="VBulletin.html#attachments_delete">attachments_delete</a></li>

                <li data-name="VBulletin#bbcode_html"><a href="VBulletin.html#bbcode_html">bbcode_html</a></li>

                <li data-name="VBulletin#bbcode_html_newthread"><a href="VBulletin.html#bbcode_html_newthread">bbcode_html_newthread</a></li>

                <li data-name="VBulletin#build_url"><a href="VBulletin.html#build_url">build_url</a></li>

                <li data-name="VBulletin#css_add"><a href="VBulletin.html#css_add">css_add</a></li>

                <li data-name="VBulletin#detect_post_error"><a href="VBulletin.html#detect_post_error">detect_post_error</a></li>

                <li data-name="VBulletin#editor_get"><a href="VBulletin.html#editor_get">editor_get</a></li>

                <li data-name="VBulletin#editor_set"><a href="VBulletin.html#editor_set">editor_set</a></li>

                <li data-name="VBulletin#forum_threads"><a href="VBulletin.html#forum_threads">forum_threads</a></li>

                <li data-name="VBulletin#get"><a href="VBulletin.html#get">get</a></li>

                <li data-name="VBulletin#get_pages"><a href="VBulletin.html#get_pages">get_pages</a></li>

                <li data-name="VBulletin#get_posts"><a href="VBulletin.html#get_posts">get_posts</a></li>

                <li data-name="VBulletin#infraction_give"><a href="VBulletin.html#infraction_give">infraction_give</a></li>

                <li data-name="VBulletin#infraction_give_custom"><a href="VBulletin.html#infraction_give_custom">infraction_give_custom</a></li>

                <li data-name="VBulletin#infraction_ids"><a href="VBulletin.html#infraction_ids">infraction_ids</a></li>

                <li data-name="VBulletin#ip_users"><a href="VBulletin.html#ip_users">ip_users</a></li>

                <li data-name="VBulletin#moderation_page"><a href="VBulletin.html#moderation_page">moderation_page</a></li>

                <li data-name="VBulletin#on_posts_modified"><a href="VBulletin.html#on_posts_modified">on_posts_modified</a></li>

                <li data-name="VBulletin#pm_send"><a href="VBulletin.html#pm_send">pm_send</a></li>

                <li data-name="VBulletin#post"><a href="VBulletin.html#post">post</a></li>

                <li data-name="VBulletin#post_create"><a href="VBulletin.html#post_create">post_create</a></li>

                <li data-name="VBulletin#post_delete"><a href="VBulletin.html#post_delete">post_delete</a></li>

                <li data-name="VBulletin#post_edit"><a href="VBulletin.html#post_edit">post_edit</a></li>

                <li data-name="VBulletin#post_info"><a href="VBulletin.html#post_info">post_info</a></li>

                <li data-name="VBulletin#post_report"><a href="VBulletin.html#post_report">post_report</a></li>

                <li data-name="VBulletin#posts_moderated"><a href="VBulletin.html#posts_moderated">posts_moderated</a></li>

                <li data-name="VBulletin#posts_move"><a href="VBulletin.html#posts_move">posts_move</a></li>

                <li data-name="VBulletin#process_posts"><a href="VBulletin.html#process_posts">process_posts</a></li>

                <li data-name="VBulletin#quotes_process"><a href="VBulletin.html#quotes_process">quotes_process</a></li>

                <li data-name="VBulletin#server_stats"><a href="VBulletin.html#server_stats">server_stats</a></li>

                <li data-name="VBulletin#spammer_delete"><a href="VBulletin.html#spammer_delete">spammer_delete</a></li>

                <li data-name="VBulletin#thread_bump"><a href="VBulletin.html#thread_bump">thread_bump</a></li>

                <li data-name="VBulletin#thread_create"><a href="VBulletin.html#thread_create">thread_create</a></li>

                <li data-name="VBulletin#thread_edit"><a href="VBulletin.html#thread_edit">thread_edit</a></li>

                <li data-name="VBulletin#thread_merge"><a href="VBulletin.html#thread_merge">thread_merge</a></li>

                <li data-name="VBulletin#thread_openclose"><a href="VBulletin.html#thread_openclose">thread_openclose</a></li>

                <li data-name="VBulletin#thread_posts"><a href="VBulletin.html#thread_posts">thread_posts</a></li>

                <li data-name="VBulletin#thread_reply"><a href="VBulletin.html#thread_reply">thread_reply</a></li>

                <li data-name="VBulletin#thread_whoposted"><a href="VBulletin.html#thread_whoposted">thread_whoposted</a></li>

                <li data-name="VBulletin#threads_complete"><a href="VBulletin.html#threads_complete">threads_complete</a></li>

                <li data-name="VBulletin#url_decode"><a href="VBulletin.html#url_decode">url_decode</a></li>

                <li data-name="VBulletin#user_ban"><a href="VBulletin.html#user_ban">user_ban</a></li>

                <li data-name="VBulletin#user_current"><a href="VBulletin.html#user_current">user_current</a></li>

                <li data-name="VBulletin#user_ips"><a href="VBulletin.html#user_ips">user_ips</a></li>

                <li data-name="VBulletin#user_moderation_info"><a href="VBulletin.html#user_moderation_info">user_moderation_info</a></li>

                <li data-name="VBulletin#usernote_add"><a href="VBulletin.html#usernote_add">usernote_add</a></li>

                <li data-name="VBulletin#users_complete"><a href="VBulletin.html#users_complete">users_complete</a></li>

                <li data-name="VBulletin#users_list_new"><a href="VBulletin.html#users_list_new">users_list_new</a></li>

                <li data-name="VBulletin#when"><a href="VBulletin.html#when">when</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

        <li class="item" data-name="Violations">
            <span class="title">
                <a href="Violations.html">Violations</a>

            </span>
            <ul class="members itemMembers">

            </ul>
            <ul class="typedefs itemMembers">

            </ul>
            <ul class="methods itemMembers">

            <span class="subtitle">Methods</span>

                <li data-name="Violations#refresh"><a href="Violations.html#refresh">refresh</a></li>

            </ul>
            <ul class="events itemMembers">

            </ul>
        </li>

    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="form_keys.js.html">Source: form_keys.js</h1>




    <section>
        <article>
            <pre class="prettyprint source "><code>/**
 * @file Manage a form that builds a set of keys
 * @author Andrew Sayers
 */

/**
 * @summary Manage a form that builds a set of keys
 * @param {BulletinBoard} bb       Bulletin board to retrieve data from
 * @param {jQuery}        form     Form to manage
 * @param {function}      callback Called when the form changes or is submitted
 * @return {jQuery} form
 *
 * @description Automatically populates certain values in a form (e.g. suggesting "user" and "thread" completions),
 * and builds a set of keys based on the inputs, in a format that can be passed to Variables.resolve()
 */
function form_keys( bb, form, callback ) {

    function call_callback( event ) {
        var keys = {};
        function add(name, value) {
            if ( !keys.hasOwnProperty(name) ) keys[ name ] = [];
            keys[ name ].push( value );
        }
        form.find('input').each(function() {
            var name = this.name, value = this.value;
            if ( value == '' ) return;
            if ( $(this).is('.user,.thread,.post') ) {
                if ( value == '' ) return;
                value = value.replace(/^\s*([0-9]+)\s*$/, this.className.replace(/.*\b(user|thread|post)\b.*/, "$1") + ' #$1' );
                var data_value = $(this).data( 'value' );
                if ( typeof(data_value) == 'undefined' ) return;
                var title, link;
                switch ( this.className.replace(/.*\b(user|thread|post)\b.*/, "$1") ) {
                case   'user': title = 'username'; link = '[URL="'+location.origin+bb.url_for.user_show({ user_id: data_value }) + '"]'+value+'[/URL]'; break;
                case 'thread': title = 'thread'  ; link = '[thread='+ data_value + ']' + value + '[/thread]'; break;
                case   'post': title = 'post'    ; link = '[post='+ data_value + ']' + value + '[/post]'; break;
                }
                keys[title               ] = [value];
                keys[title + ' with link'] = [link];
                add( title + 's', value );
                add( title + 's with links', link );
                add( name, value );
                add( name + ' with links', link );
                add( name + ' with link', link );
                add( name + ' values', data_value );
            } else {
                add(name, value);
            }
        });
        return callback(keys, event);
    }

    function update_element( element, value ) {
        if ( value === null ) {
            element.attr( 'data-blocked', 'blocked' );
            form.find('[type="submit"]').prop( 'disabled', true );
        } else {
            element.removeAttr( 'data-blocked' );
            element.data( 'value', value );
        }
    }

    var type_handlers = {
          user: function(val) { return bb.  users_complete( val ).then(function(vals) { return vals.map(function(val) { return { name: val.username, value: val.  user_id } }); }) },
        thread: function(val) { return bb.threads_complete( val ).then(function(vals) { return vals.map(function(val) { return { name: val.title   , value: val.thread_id } }); }) },
          post: function(   ) { var dfd = new jQuery.Deferred(); dfd.resolve([]); return dfd.promise() }
    };

    var timeout, known = {
          user: {},
        thread: {},
          post: {}
    };

    return form

        // Create and destroy multiple inputs:
        .on( 'blur', '.multi:not(:last-child) input', function() {
            if ( $(this).val() == '' ) {
                // remove empty inputs, except the last one
                $(this).closest('.multi').remove();
            }
        })
        .on( 'input change', '.multi:last-child input', function() {
            if ( $(this).val() != '' ) {
                // remove empty inputs, except the last one
                $(this).closest('.multi')
                    .clone()
                    .insertAfter($(this).closest('.multi'))
                    .find('input').val('')
                ;
            }
        })

        // Handle inputs that switch type:
        .on( 'change', '.switch', function() {
            var type = $(this).val().toLowerCase();
            $(this).closest('tr').find('input')
                .attr( 'class', type )
                .attr( 'list' , 'mod-friend-data-for-' + type );
        })

        // Handle common input types:
        .on( 'input change', '.user,.thread,.post', function() {

            var $this = $(this), text = $this.val(), select = $(this).closest('.multi').find('select');

            // special case for the empty string
            if ( text == '' ) {
                update_element( $this, '' );
                return;
            }

            // set type and value by URL
            var url_data = bb.url_decode( text );
            if ( url_data ) {
                select.val(
                    select.children('option').filter(function() { return $(this).text().toLowerCase() == url_data.type }).text()
                );
                $this.attr( 'class', url_data.type ).attr( 'list' , 'mod-friend-data-for-' + url_data.type );
                $this.val( url_data.type + ' #' + url_data.args[url_data.type+'_id'] );
                update_element( $this, url_data.args[url_data.type+'_id'] );
                return;
            }

            // set type and value by predefined string
            if ( text.replace( /^\s*(user|thread|post)?\s*#*([0-9]+)\s*$/i, function( text, type, id ) {
                if ( type ) {
                    type = type.toLowerCase();
                    select.val(
                        select.children('option').filter(function() { return $(this).text().toLowerCase() == type }).text()
                    );
                    $this.attr( 'class', type ).attr( 'list' , 'mod-friend-data-for-' + type );
                }
                update_element( $this, id );
                return '';
            }) != text ) {
                return;
            };

            // guess value
            var datalist = $( '#' + $this.attr('list') ), type = this.className.replace(/.*\b(user|thread|post)\b.*/, "$1"), known_things = known[type];
            update_element( $this, known_things.hasOwnProperty(text.toLowerCase()) ? known_things[text.toLowerCase()] : null );
            if ( timeout ) clearTimeout(timeout);
            timeout = setTimeout(function() {
                type_handlers[type]( text ).then(function(values) {
                    timeout = null;
                    values.forEach(function(value) {
                        if ( !known_things.hasOwnProperty(value.name.toLowerCase()) ) {
                            datalist.append( $('&lt;option>').text(value.name) );
                            known_things[value.name.toLowerCase()] = value.value;
                            if ( value.name.toLowerCase() == text.toLowerCase() ) {
                                update_element( $this, value.value );
                                call_callback();
                            }
                        }
                    });
                });
            }, 500 );

        })

        // Manage the submission process:
        .on( 'input change', function() {
            form.find('[type="submit"]').prop( 'disabled', !!form.find('[data-blocked]').length );
            call_callback();
        })

        .on( 'submit', function(event) {
            return !form.find('[data-blocked]').length &amp;&amp; call_callback(event);
        });

}
</code></pre>
        </article>
    </section>








        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta1</a> on 26 March 2015
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
